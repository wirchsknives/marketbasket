<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');
        #divHeader h1 {
            font-family: 'Comic Neue', cursive;
            font-size: 2.5rem;
            color: #333;
        }
        #divHeader img {
            height: 1.5in;
            width: auto;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #divMessage {
            border: 2px solid #ccc;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .editable-cell {
            cursor: pointer;
        }
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        .checked-row td:not(:first-child) {
            background-color: #e6ffe6;
        }
        .unchecked-row td:not(:first-child) {
            background-color: #fff3cd;
            text-decoration: line-through;
        }
        #divUIHeader {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #divUIDetail {
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div id="divHeader" class="d-flex align-items-center position-relative">
            <h1>Market Basket Data Input</h1>
            <img src="images/MarketBasket.png" alt="Market Basket Logo">
        </div>
        <div id="divMessage" class="alert alert-info" style=width:75%; >
            Please enter your email address so we can authenticate you.
        </div>
        <div id="divUserInput">
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <button type="button" id="sendCodeBtn" class="btn btn-primary">Send Code</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            let tableData = [];
            const columns = [
                { id: 1, name: 'Department Code Desc' },
                { id: 2, name: 'Job Class Code Desc' },
                { id: 3, name: 'Scheduled Hours' },
                { id: 4, name: 'Hourly Rate' },
                { id: 5, name: 'Annual Pay' }
            ];

            // Send authentication code
            $('#sendCodeBtn').click(function() {
                const email = $('#email').val().trim();
                if (!email) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please enter a valid email address.');
                    return;
                }

                $.ajax({
                    url: 'ajax/sendCode.php',
                    type: 'POST',
                    data: { email },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            $('#divMessage').removeClass('alert-danger').addClass('alert-info').text(response.message);
                            $('#divUserInput').html(`
                                <div class="mb-3">
                                    <label for="authCode" class="form-label">Enter Authentication Code</label>
                                    <input type="text" class="form-control" id="authCode" maxlength="6" required>
                                </div>
                                <button type="button" id="verifyCodeBtn" class="btn btn-primary">Verify Code</button>
                                <button type="button" id="resendCodeBtn" class="btn btn-secondary ms-2">Resend Code</button>
                            `);
                        } else {
                            $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                        }
                    },
                    error: function() {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                    }
                });
            });

            // Resend code
            $(document).on('click', '#resendCodeBtn', function() {
                $('#sendCodeBtn').click();
            });

            // Verify authentication code
            $(document).on('click', '#verifyCodeBtn', function() {
                const code = $('#authCode').val().trim();
                if (!code || code.length !== 6) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please enter a 6-character code.');
                    return;
                }

                $.ajax({
                    url: 'ajax/verifyCode.php',
                    type: 'POST',
                    data: { code },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Choose a data entry method.');
                            $('#divUserInput').html(`
                                <div class="mb-3">
                                    <button type="button" id="manualEntryBtn" class="btn btn-primary me-2">Manual Entry</button>
                                    <button type="button" id="uploadFileBtn" class="btn btn-primary me-2">Upload File</button>
                                    <button type="button" id="copyPasteBtn" class="btn btn-primary">Copy and Paste</button>
                                </div>
                            `);
                        } else {
                            $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                        }
                    },
                    error: function() {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                    }
                });
            });

            // Manual entry
            $(document).on('click', '#manualEntryBtn', function() {
                tableData = [];
                renderTable();
            });

            // Upload file
            $(document).on('click', '#uploadFileBtn', function() {
                $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Upload an Excel file with the required columns.');
                $('#divUserInput').html(`
                    <div class="mb-3">
                        <p>Instructions: Open Munis, navigate to Enterprise ERP > Human Capital Management > Payroll > Employee Maintenance > Employee Inquiry. Select employees with Status > Active, choose a department range or other fields, then click Excel to export. Ensure the file includes: Department Code Desc, Job Class Code Desc, Scheduled Hours, Hourly Rate, Annual Pay.</p>
                        <label for="excelFile" class="form-label">Upload Excel File (.xlsx, max 50MB)</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx">
                    </div>
                    <button type="button" id="processExcelBtn" class="btn btn-primary">Process File</button>
                `);
            });

            $(document).on('click', '#processExcelBtn', function() {
                const fileInput = $('#excelFile')[0];
                if (!fileInput.files.length) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please select a file.');
                    return;
                }

                const formData = new FormData();
                formData.append('excelFile', fileInput.files[0]);

                $.ajax({
                    url: 'ajax/processExcel.php',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            tableData = response.data.map(row => ({ ...row, checked: true }));
                            renderTable(response.email, response.town);
                        } else {
                            $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                        }
                    },
                    error: function() {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                    }
                });
            });

            // Copy and paste
            $(document).on('click', '#copyPasteBtn', function() {
                $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Paste comma or tab-separated data with the required columns.');
                $('#divUserInput').html(`
                    <div class="mb-3">
                        <label for="uiCopyPasteData" class="form-label">Paste Data (comma or tab-separated)</label>
                        <textarea class="form-control" id="uiCopyPasteData" rows="10"></textarea>
                    </div>
                    <button type="button" id="btnProcessCopyAndPasteData" class="btn btn-primary">Process Data</button>
                `);
            });

            $(document).on('click', '#btnProcessCopyAndPasteData', function() {
                const data = $('#uiCopyPasteData').val().trim();
                if (!data) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please paste some data.');
                    return;
                }

                $.ajax({
                    url: 'ajax/processCopyPaste.php',
                    type: 'POST',
                    data: { data },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            tableData = response.data.map(row => ({ ...row, checked: true }));
                            renderTable(response.email, response.town);
                        } else {
                            $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                        }
                    },
                    error: function() {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                    }
                });
            });

            // Render table
            function renderTable(email = '', town = '') {
                let html = `
                    <div id="divUIHeader">
                        <strong>Email:</strong> ${email} | <strong>Town:</strong> ${town}
                    </div>
                    <div id="divUIDetail">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll" ${tableData.every(row => row.checked) ? 'checked' : ''}></th>
                                    ${columns.map(col => `<th>${col.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                tableData.forEach((row, index) => {
                    html += `
                        <tr class="${row.checked ? 'checked-row' : 'unchecked-row'}">
                            <td><input type="checkbox" class="row-checkbox" data-index="${index}" ${row.checked ? 'checked' : ''}></td>
                            ${columns.map(col => `
                                <td class="editable-cell" data-index="${index}" data-column="${col.id}" contenteditable="true">${row[col.id] || ''}</td>
                            `).join('')}
                        </tr>
                    `;
                });
                html += `
                        <tr class="checked-row">
                            <td><input type="checkbox" checked></td>
                            ${columns.map(col => `<td class="editable-cell new-row" data-column="${col.id}" contenteditable="true"></td>`).join('')}
                        </tr>
                        </tbody>
                    </table>
                    <button type="button" id="submitDataBtn" class="btn btn-primary mt-3">Submit Data</button>
                    <a href="analyzeMarketBasket.html" class="btn btn-secondary mt-3 ms-2">Analyze Data</a>
                    </div>
                `;
                $('#divUserInput').html(html);
                $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Enter or edit data, then click Submit or Analyze.');
            }

            // Handle select all
            $(document).on('change', '#selectAll', function() {
                const checked = $(this).prop('checked');
                $('.row-checkbox').prop('checked', checked).each(function() {
                    const index = $(this).data('index');
                    if (tableData[index]) {
                        tableData[index].checked = checked;
                        $(this).closest('tr').toggleClass('checked-row', checked).toggleClass('unchecked-row', !checked);
                    }
                });
            });

            // Handle row checkbox
            $(document).on('change', '.row-checkbox', function() {
                const index = $(this).data('index');
                if (tableData[index]) {
                    tableData[index].checked = $(this).prop('checked');
                    $(this).closest('tr').toggleClass('checked-row', tableData[index].checked).toggleClass('unchecked-row', !tableData[index].checked);
                }
                updateSelectAll();
            });

            // Update select all checkbox
            function updateSelectAll() {
                const allChecked = $('.row-checkbox').length === $('.row-checkbox:checked').length;
                $('#selectAll').prop('checked', allChecked);
            }

            // Handle cell edits
            $(document).on('blur', '.editable-cell', function() {
                const index = $(this).data('index');
                const column = $(this).data('column');
                const value = $(this).text().trim();
                if (index !== undefined && tableData[index]) {
                    if ((column >= 3 && !isNaN(value) && value !== '') || (column < 3)) {
                        tableData[index][column] = value;
                    } else if (column >= 3) {
                        $(this).text(tableData[index][column] || '');
                        alert('Please enter a numeric value for ' + columns.find(c => c.id == column).name);
                    }
                }
            });

            // Handle new row
            $(document).on('blur', '.new-row', function() {
                const newRow = { checked: true };
                let hasData = false;
                $('.new-row').each(function() {
                    const column = $(this).data('column');
                    const value = $(this).text().trim();
                    if (value) {
                        hasData = true;
                        if ((column >= 3 && !isNaN(value)) || (column < 3)) {
                            newRow[column] = value;
                        } else {
                            $(this).text('');
                            alert('Please enter a numeric value for ' + columns.find(c => c.id == column).name);
                        }
                    }
                });
                if (hasData) {
                    tableData.push(newRow);
                    renderTable();
                }
            });

            // Submit data
            $(document).on('click', '#submitDataBtn', function() {
                if (!tableData.length) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('No data to submit.');
                    return;
                }

                $.ajax({
                    url: 'ajax/submitData.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(tableData),
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            $('#divMessage').removeClass('alert-danger').addClass('alert-success').text(response.message);
                            tableData = [];
                            renderTable();
                        } else {
                            $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                        }
                    },
                    error: function() {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                    }
                });
            });
        });
    </script>
</body>
</html>