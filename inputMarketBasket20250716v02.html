<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');
        #divHeader h1 {
            font-family: 'Comic Neue', cursive;
            font-size: 2.5rem;
            color: #333;
        }
        #divHeader img {
            height: 1.5in;
            width: auto;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #divMessage {
            border: 2px solid #ccc;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            width: 75%;
        }
        .editable-cell {
            cursor: pointer;
        }
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        .checked-row td:not(:first-child) {
            background-color: #e6ffe6;
        }
        .unchecked-row td:not(:first-child) {
            background-color: #fff3cd;
            text-decoration: line-through;
        }
        .blank-cell {
            background-color: yellow !important;
        }
        #divUIHeader {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #divUIDetail {
            font-weight: normal;
        }
    </style>
</head>
<body>
    <!-- HTML body remains unchanged -->
    <div class="container mt-3">
        <div id="divHeader" class="d-flex align-items-center position-relative">
            <h1>Market Basket Data Input</h1>
            <img src="images/MarketBasket.png" alt="Market Basket Logo">
        </div>
        <div id="divMessage" class="alert alert-info">
            Please enter your email address so we can authenticate you.
        </div>
        <div id="divUserInput">
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <button type="button" id="sendCodeBtn" class="btn btn-primary">Send Code</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // Define showInputOptions globally
    function showInputOptions() {
        $.ajax({
            url: 'ajax/checkExistingData.php',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    const hasData = response.hasData;
                    $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Choose a data entry method.');
                    $('#divUserInput').html(`
                        <div class="mb-3">
                            <button type="button" id="manualEntryBtn" class="btn btn-primary me-2">Manual Entry</button>
                            <button type="button" id="uploadFileBtn" class="btn btn-primary me-2">Upload File</button>
                            <button type="button" id="copyPasteBtn" class="btn btn-primary me-2">Copy and Paste</button>
                            <button type="button" id="editExistingBtn" class="btn btn-primary" ${hasData ? '' : 'disabled'}>Edit Existing Data</button>
                        </div>
                    `);
                } else {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                }
            },
            error: function() {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error checking for existing data.');
            }
        });
    }

    // Helper function to parse CSV rows (handles quoted values)
    function parseCSVRow(row, delimiter) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < row.length; i++) {
            const char = row[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === delimiter && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }



    $(document).ready(function() {
        let tableData = [];
        let isEditingExisting = false;
        let selectedHeaderId = null;
        let newRowData = { checked: true }; // Store temporary new row data
        let standardDepartments = []; // Store standard departments
        let standardJobClasses = []; // Store standard job classes
        const columns = [
            { id: 1, name: 'Department Code Desc' },
            { id: 2, name: 'Job Class Code Desc' },
            { id: 3, name: 'Scheduled Hours' },
            { id: 4, name: 'Hourly Rate' },
            { id: 5, name: 'Annual Pay' }
        ];

        // Fetch standard departments and job classes
        function loadStandardValues() {
            $.ajax({
                url: 'ajax/getStandardValues.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        standardDepartments = response.departments; // [{id, StandardDeptDesc}]
                        standardJobClasses = response.jobClasses; // [{id, StandardJobClassDesc}]
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error loading standard values.');
                }
            });
        }

        // Call on page load
        loadStandardValues();

        // Function to validate checked rows and toggle submit button Lillbutton
        function validateAndToggleSubmitButton() {
            let allValid = true;
            $('.row-checkbox:checked').each(function() {
                const index = $(this).data('index');
                const row = tableData[index];
                if (row && row.checked) {
                    for (let i = 1; i <= 5; i++) {
                        if (!row[i] || row[i].trim() === '') {
                            allValid = false;
                            break;
                        }
                    }
                }
            });
            $('#submitDataBtn').prop('disabled', !allValid);
        }

        // Render table (preserves new row data)
        function renderTable(email = '', town = '') {
            let html = `
                <div id="divUIHeader">
                    <strong>Email:</strong> ${email} | <strong>Town:</strong> ${town}
                </div>
                <div id="divUIDetail">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" ${tableData.every(row => row.checked) ? 'checked' : ''}></th>
                                ${columns.map(col => `<th>${col.name}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            tableData.forEach((row, index) => {
                html += `
                    <tr class="${row.checked ? 'checked-row' : 'unchecked-row'}">
                        <td><input type="checkbox" class="row-checkbox" data-index="${index}" ${row.checked ? 'checked' : ''}></td>
                        ${columns.map(col => `
                            <td class="editable-cell ${row.checked && (!row[col.id] || row[col.id].trim() === '') ? 'blank-cell' : ''}" data-index="${index}" data-column="${col.id}" contenteditable="true">${row[col.id] || ''}</td>
                        `).join('')}
                        <td>
                            <select class="form-control standard-dept" data-index="${index}" ${col.id == 1 ? '' : 'style="display:none;"'}>
                                <option value="">Select Standard Department</option>
                                ${standardDepartments.map(dept => `<option value="${dept.id}" ${row.standardDeptID == dept.id ? 'selected' : ''}>${dept.StandardDeptDesc}</option>`).join('')}
                            </select>
                            <select class="form-control standard-job" data-index="${index}" ${col.id == 2 ? '' : 'style="display:none;"'}>
                                <option value="">Select Standard Job Class</option>
                                ${standardJobClasses.map(job => `<option value="${job.id}" ${row.standardJobClassID == job.id ? 'selected' : ''}>${job.StandardJobClassDesc}</option>`).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            });
            html += `
                    <tr class="checked-row new-row">
                        <td><input type="checkbox" checked></td>
                        ${columns.map(col => `
                            <td class="editable-cell new-row ${!newRowData[col.id] || newRowData[col.id].trim() === '' ? 'blank-cell' : ''}" data-column="${col.id}" contenteditable="true">${newRowData[col.id] || ''}</td>
                        `).join('')}
                        <td>
                            <select class="form-control standard-dept new-row" data-column="1" style="display:${col.id == 1 ? 'block' : 'none'};">
                                <option value="">Select Standard Department</option>
                                ${standardDepartments.map(dept => `<option value="${dept.id}" ${newRowData.standardDeptID == dept.id ? 'selected' : ''}>${dept.StandardDeptDesc}</option>`).join('')}
                            </select>
                            <select class="form-control standard-job new-row" data-column="2" style="display:${col.id == 2 ? 'block' : 'none'};">
                                <option value="">Select Standard Job Class</option>
                                ${standardJobClasses.map(job => `<option value="${job.id}" ${newRowData.standardJobClassID == job.id ? 'selected' : ''}>${job.StandardJobClassDesc}</option>`).join('')}
                            </select>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <button type="button" id="submitDataBtn" class="btn btn-primary mt-3">Submit Data</button>
                <a href="analyzeMarketBasket.html" class="btn btn-secondary mt-3 ms-2">Analyze Data</a>
                <button type="button" class="btn btn-secondary mt-3 ms-2" onclick="showInputOptions()">Back to Input Options</button>
                </div>
            `;
            $('#divUserInput').html(html);
            validateAndToggleSubmitButton();
        }

        // ... (authentication handlers unchanged: sendCodeBtn, verifyCodeBtn, resendCodeBtn) ...

        // Manual entry
        $(document).on('click', '#manualEntryBtn', function() {
            isEditingExisting = false;
            selectedHeaderId = null;
            tableData = [];
            newRowData = { checked: true }; // Reset new row data
            renderTable();
            validateAndToggleSubmitButton();
        });

        // ... (upload file, copy and paste, edit existing handlers unchanged) ...

        // Handle standard department and job class selection
        $(document).on('change', '.standard-dept', function() {
            const index = $(this).data('index');
            const value = $(this).val();
            if (index !== undefined && tableData[index]) {
                tableData[index].standardDeptID = value ? parseInt(value) : null;
            } else {
                newRowData.standardDeptID = value ? parseInt(value) : null;
            }
            validateAndToggleSubmitButton();
        });

        $(document).on('change', '.standard-job', function() {
            const index = $(this).data('index');
            const value = $(this).val();
            if (index !== undefined && tableData[index]) {
                tableData[index].standardJobClassID = value ? parseInt(value) : null;
            } else {
                newRowData.standardJobClassID = value ? parseInt(value) : null;
            }
            validateAndToggleSubmitButton();
        });

        // Handle new row cell edits
        $(document).on('input', '.new-row.editable-cell', function() {
            const column = $(this).data('column');
            const value = $(this).text().trim();
            console.log('Input in column:', column, 'value:', value); // Debug

            // Update newRowData and validate input
            if ((column >= 3 && !isNaN(value) && value !== '') || (column < 3)) {
                newRowData[column] = value;
                $(this).removeClass('blank-cell');
                if (!value || value.trim() === '') {
                    newRowData[column] = '';
                    $(this).addClass('blank-cell');
                }
            } else if (column >= 3 && value !== '') {
                $(this).text('');
                newRowData[column] = '';
                alert('Please enter a numeric value for ' + columns.find(c => c.id == column).name);
                $(this).addClass('blank-cell');
                return; // Exit to prevent checking row completion with invalid data
            }
            console.log('newRowData:', newRowData); // Debug

            // Check if all columns are filled and valid
            let allFilled = true;
            let isValid = true;
            for (let i = 1; i <= 5; i++) {
                const val = newRowData[i] || '';
                if (!val || val.trim() === '') {
                    allFilled = false;
                }
                if (i >= 3 && val && isNaN(val)) {
                    isValid = false;
                }
            }
            console.log('allFilled:', allFilled, 'isValid:', isValid); // Debug

            if (allFilled && isValid) {
                console.log('Committing newRowData to tableData:', { ...newRowData }); // Debug
                const newRowIndex = tableData.length; // Index of the newly added row
                tableData.push({ ...newRowData });
                newRowData = { checked: true }; // Reset new row data
                renderTable();
                // Restore focus to the same column in the newly added row
                const newCell = $(`.editable-cell[data-index="${newRowIndex}"][data-column="${column}"]`);
                if (newCell.length) {
                    newCell.focus();
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(newCell[0]);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
                $('.new-row.editable-cell').each(function() {
                    const col = $(this).data('column');
                    $(this).toggleClass('blank-cell', !newRowData[col] || newRowData[col].trim() === '');
                });
            }
            validateAndToggleSubmitButton();
        });

        // Handle new row submission (on Enter key)
        $(document).on('keydown', '.new-row.editable-cell', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const column = $(this).data('column');
                let hasData = false;
                let isValid = true;
                $('.new-row.editable-cell').each(function() {
                    const col = $(this).data('column');
                    const value = $(this).text().trim();
                    if (value) {
                        hasData = true;
                        if (col >= 3 && isNaN(value)) {
                            isValid = false;
                            alert('Please enter a numeric value for ' + columns.find(c => c.id == col).name);
                            $(this).text('');
                            newRowData[col] = '';
                            $(this).addClass('blank-cell');
                        } else {
                            newRowData[col] = value;
                        }
                    } else {
                        newRowData[col] = '';
                        $(this).addClass('blank-cell');
                    }
                });

                if (hasData && isValid) {
                    console.log('Enter key: Committing newRowData to tableData:', { ...newRowData }); // Debug
                    const newRowIndex = tableData.length; // Index of the newly added row
                    tableData.push({ ...newRowData });
                    newRowData = { checked: true }; // Reset new row data
                    renderTable();
                    const newCell = $(`.editable-cell[data-index="${newRowIndex}"][data-column="${column}"]`);
                    if (newCell.length) {
                        newCell.focus();
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(newCell[0]);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                    $('.new-row.editable-cell').each(function() {
                        const col = $(this).data('column');
                        $(this).toggleClass('blank-cell', !newRowData[col] || newRowData[col].trim() === '');
                    });
                }
                validateAndToggleSubmitButton();
            }
        });

        // Submit data
        $(document).on('click', '#submitDataBtn', function() {
            if (!tableData.length) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('No data to submit.');
                return;
            }
            // Validate tableData structure
            for (let row of tableData) {
                if (!row.hasOwnProperty('checked')) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Invalid data: Missing checked property.');
                    return;
                }
                for (let i = 1; i <= 5; i++) {
                    if (row.checked && (!row[i] || row[i].trim() === '')) {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(`Missing value in column ${columns.find(c => c.id == i).name} for a checked row.`);
                        return;
                    }
                    if (row[i] && i >= 3 && isNaN(row[i])) {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(`Invalid numeric value in column ${i}.`);
                        return;
                    }
                }
            }
            const url = isEditingExisting ? 'ajax/updateData.php' : 'ajax/submitData.php';
            const dataToSend = isEditingExisting ? { headerId: selectedHeaderId, data: tableData } : tableData;
            console.log('Submitting to:', url);
            console.log('Data to send:', JSON.stringify(dataToSend, null, 2));
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response);
                    if (response.success) {
                        $('#divMessage').removeClass('alert-danger').addClass('alert-success').text(response.message);
                        tableData = [];
                        newRowData = { checked: true }; // Reset new row data
                        renderTable();
                        showInputOptions();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                }
            });
        });
    });
</script>
</body>
</html>