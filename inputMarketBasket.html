<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');
        #divHeader h1 {
            font-family: 'Comic Neue', cursive;
            font-size: 2.5rem;
            color: #333;
        }
        #divHeader img {
            height: 1.5in;
            width: auto;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #divMessage {
            border: 2px solid #ccc;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            width: 75%;
        }
        .editable-cell {
            cursor: pointer;
        }
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        .checked-row td:not(:first-child) {
            background-color: #e6ffe6;
        }
        .unchecked-row td:not(:first-child) {
            background-color: #fff3cd;
            text-decoration: line-through;
        }
        .blank-cell {
            background-color: yellow !important;
        }
        #divUIHeader {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #divUIDetail {
            font-weight: normal;
        }
    </style>
</head>
<body>
    <!-- HTML body remains unchanged -->
    <div class="container mt-3">
        <div id="divHeader" class="d-flex align-items-center position-relative">
            <h1>Market Basket Data Input</h1>
            <img src="images/MarketBasket.png" alt="Market Basket Logo">
        </div>
        <div id="divMessage" class="alert alert-info">
            Please enter your email address so we can authenticate you.
        </div>
        <div id="divUserInput">
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <button type="button" id="sendCodeBtn" class="btn btn-primary">Send Code</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // Define showInputOptions globally
    function showInputOptions() {
        $.ajax({
            url: 'ajax/checkExistingData.php',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    const hasData = response.hasData;
                    $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Choose a data entry method.');
                    $('#divUserInput').html(`
                        <div class="mb-3">
                            <button type="button" id="manualEntryBtn" class="btn btn-primary me-2">Manual Entry</button>
                            <button type="button" id="uploadFileBtn" class="btn btn-primary me-2">Upload File</button>
                            <button type="button" id="copyPasteBtn" class="btn btn-primary me-2">Copy and Paste</button>
                            <button type="button" id="editExistingBtn" class="btn btn-primary" ${hasData ? '' : 'disabled'}>Edit Existing Data</button>
                        </div>
                    `);
                } else {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                }
            },
            error: function() {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error checking for existing data.');
            }
        });
    }

    // Helper function to parse CSV rows (handles quoted values)
    function parseCSVRow(row, delimiter) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < row.length; i++) {
            const char = row[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === delimiter && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }



    $(document).ready(function() {
        let tableData = [];
        let isEditingExisting = false;
        let selectedHeaderId = null;
        let newRowData = { checked: true }; // Store temporary new row data
        let standardDepartments = []; // Store standard departments
        let standardJobClasses = []; // Store standard job classes
   /*     const columns = [
            { id: 1, name: 'Department Code Desc' },
            { id: 2, name: 'Job Class Code Desc' },
            { id: 3, name: 'Scheduled Hours' },
            { id: 4, name: 'Hourly Rate' },
            { id: 5, name: 'Annual Pay' }
        ]; */
        const columns = [
            { id: 10, name: 'Row' },
            { id: 1, name: 'Department Code Desc' },
            { id: 2, name: 'Job Class Code Desc' },
            { id: 3, name: 'Scheduled Hours' },
            { id: 4, name: 'Hourly Rate' },
            { id: 5, name: 'Annual Pay' },
            { id: 6, name: 'Degree' },
            { id: 7, name: 'Standard Dept ID' },
            { id: 8, name: 'Standard Job Class ID' }
        ];

        // Fetch standard departments and job classes
        function loadStandardValues() {
            $.ajax({
                url: 'ajax/getStandardValues.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        standardDepartments = response.departments; // [{id, StandardDeptDesc}]
                        standardJobClasses = response.jobClasses; // [{id, StandardJobClassDesc}]
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error loading standard values.');
                }
            });
        }

        // Call on page load
        loadStandardValues();

        // Function to validate checked rows and toggle submit button Lillbutton
        function validateAndToggleSubmitButton() {
            let allValid = true;
            $('.row-checkbox:checked').each(function() {
                const index = $(this).data('index');
                const row = tableData[index];
                if (row && row.checked) {
                    for (let i = 1; i <= 5; i++) {
                        if (!row[i] || row[i].trim() === '') {
                            allValid = false;
                            break;
                        }
                    }
                }
            });
            $('#submitDataBtn').prop('disabled', !allValid);
        }

        // Render table (preserves new row data)
function renderTable(email = '', town = '') {
    let html = `
        <div id="divUIHeader">
            <strong>Email:</strong> ${email} | <strong>Town:</strong> ${town}
        </div>
        <div id="divUIDetail">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" ${tableData.every(row => row.checked) ? 'checked' : ''}></th>
                        ${columns.map(col => `<th>${col.name}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
    `;

/*    tableData.forEach((row, index) => {
        html += `
            <tr class="${row.checked ? 'checked-row' : 'unchecked-row'}">
                <td><input type="checkbox" class="row-checkbox" data-index="${index}" ${row.checked ? 'checked' : ''}></td>
                ${columns.map(col => `
                    <td class="editable-cell ${row.checked && (!row[col.id] || row[col.id].trim() === '') ? 'blank-cell' : ''}" data-index="${index}" data-column="${col.id}" contenteditable="true">${row[col.id] || ''}</td>
                `).join('')}
                <td>
                    <select class="form-control standard-dept" data-index="${index}" style="display:block;">
                        <option value="">Select Standard Department</option>
                        ${standardDepartments.map(dept => `<option value="${dept.id}" ${row.standardDeptID == dept.id ? 'selected' : ''}>${dept.StandardDeptDesc}</option>`).join('')}
                    </select>
                    <select class="form-control standard-job" data-index="${index}" style="display:none;">
                        <option value="">Select Standard Job Class</option>
                        ${standardJobClasses.map(job => `<option value="${job.id}" ${row.standardJobClassID == job.id ? 'selected' : ''}>${job.StandardJobClassDesc}</option>`).join('')}
                    </select>
                </td>
            </tr>
        `;
    }); */
/*    tableData.forEach((row, index) => {
    const isChecked = row[9] === "1";

    html += `
        <tr class="${isChecked ? 'checked-row' : 'unchecked-row'}">
            <td><input type="checkbox" class="row-checkbox" data-index="${index}" ${isChecked ? 'checked' : ''}></td>
            ${columns.map(col => {
                const content = row[col.id] || '';
                if (col.id === 10) {
                    // Row ID - non-editable plain text
                    return `<td>${content}</td>`;
                }
                return `<td class="editable-cell ${isChecked && (!content || content.trim() === '') ? 'blank-cell' : ''}" data-index="${index}" data-column="${col.id}" contenteditable="true">${content}</td>`;
            }).join('')}
            <td>
                <select class="form-control standard-dept" data-index="${index}" style="display:block;">
                    <option value="">Select Standard Department</option>
                    ${standardDepartments.map(dept => `<option value="${dept.id}" ${row[7] == dept.id ? 'selected' : ''}>${dept.StandardDeptDesc}</option>`).join('')}
                </select>
                <select class="form-control standard-job" data-index="${index}" style="display:none;">
                    <option value="">Select Standard Job Class</option>
                    ${standardJobClasses.map(job => `<option value="${job.id}" ${row[8] == job.id ? 'selected' : ''}>${job.StandardJobClassDesc}</option>`).join('')}
                </select>
            </td>
        </tr>
    `;
}); */
  tableData.forEach((row, index) => {
    const isChecked = row[9] === "1";

    html += `
        <tr class="${isChecked ? 'unchecked-row' : 'checked-row'}">
            <td><input type="checkbox" class="row-checkbox" data-index="${index}" ${isChecked ? '' : 'checked'}></td>
            ${columns.map(col => {
                if (col.id === 10) {
                    // Row ID (non-editable text)
                    return `<td>${row[col.id] || ''}</td>`;
                }
                if (col.id === 7) {
                    // StandardDeptID dropdown
                    return `
                        <td>
                            <select class="form-control standard-dept" data-index="${index}">
                                <option value="">Select Standard Department</option>
                                ${standardDepartments.map(dept => `
                                    <option value="${dept.id}" ${row[7] == dept.id ? 'selected' : ''}>
                                        ${dept.StandardDeptDesc}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                    `;
                }
                if (col.id === 8) {
                    // StandardJobClassID dropdown
                    return `
                        <td>
                            <select class="form-control standard-job" data-index="${index}">
                                <option value="">Select Standard Job Class</option>
                                ${standardJobClasses.map(job => `
                                    <option value="${job.id}" ${row[8] == job.id ? 'selected' : ''}>
                                        ${job.StandardJobClassDesc}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                    `;
                }
                // All other editable text cells
                return `<td class="editable-cell ${isChecked && (!row[col.id] || row[col.id].trim() === '') ? 'blank-cell' : ''}" data-index="${index}" data-column="${col.id}" contenteditable="true">${row[col.id] || ''}</td>`;
            }).join('')}
        </tr>
    `;
});
  
    html += `
            <tr class="checked-row new-row">
                <td><input type="checkbox" checked></td>
                ${columns.map(col => `
                    <td class="editable-cell new-row ${!newRowData[col.id] || newRowData[col.id].trim() === '' ? 'blank-cell' : ''}" data-column="${col.id}" contenteditable="true">${newRowData[col.id] || ''}</td>
                `).join('')}
                <td>
                    <select class="form-control standard-dept new-row" data-column="1" style="display:block;">
                        <option value="">Select Standard Department</option>
                        ${standardDepartments.map(dept => `<option value="${dept.id}" ${newRowData.standardDeptID == dept.id ? 'selected' : ''}>${dept.StandardDeptDesc}</option>`).join('')}
                    </select>
                    <select class="form-control standard-job new-row" data-column="2" style="display:none;">
                        <option value="">Select Standard Job Class</option>
                        ${standardJobClasses.map(job => `<option value="${job.id}" ${newRowData.standardJobClassID == job.id ? 'selected' : ''}>${job.StandardJobClassDesc}</option>`).join('')}
                    </select>
                </td>
            </tr>
            </tbody>
        </table>
        <button type="button" id="submitDataBtn" class="btn btn-primary mt-3">Submit Data</button>
        <a href="analyzeMarketBasket.html" class="btn btn-secondary mt-3 ms-2">Analyze Data</a>
        <button type="button" class="btn btn-secondary mt-3 ms-2" onclick="showInputOptions()">Back to Input Options</button>
        </div>
    `;
    $('#divUserInput').html(html);
    validateAndToggleSubmitButton();
}
        // Check session on page load
        $.ajax({
            url: 'ajax/checkSession.php',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.authenticated) {
                    showInputOptions();
                }
            },
            error: function() {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error checking session.');
            }
        });

        // Send authentication code
        $('#sendCodeBtn').click(function() {
            const email = $('#email').val().trim();
            if (!email) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please enter a valid email address.');
                return;
            }

            $.ajax({
                url: 'ajax/sendCode.php',
                type: 'POST',
                data: { email },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        $('#divMessage').removeClass('alert-danger').addClass('alert-info').text(response.message);
                        $('#divUserInput').html(`
                            <div class="mb-3">
                                <label for="authCode" class="form-label">Enter Authentication Code</label>
                                <input type="text" class="form-control" id="authCode" maxlength="6" required>
                            </div>
                            <button type="button" id="verifyCodeBtn" class="btn btn-primary">Verify Code</button>
                            <button type="button" id="resendCodeBtn" class="btn btn-secondary ms-2">Resend Code</button>
                        `);
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                }
            });
        });


        // Resend code
        $(document).on('click', '#resendCodeBtn', function() {
            $('#sendCodeBtn').click();
        });

        // Verify authentication code
        $(document).on('click', '#verifyCodeBtn', function() {
            const code = $('#authCode').val().trim();
            if (!code || code.length !== 6) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please enter a 6-character code.');
                return;
            }

            $.ajax({
                url: 'ajax/verifyCode.php',
                type: 'POST',
                data: { code },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        showInputOptions();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                }
            });
        });
        // Manual entry
        $(document).on('click', '#manualEntryBtn', function() {
            isEditingExisting = false;
            selectedHeaderId = null;
            tableData = [];
            newRowData = { checked: true }; // Reset new row data
            renderTable();
            validateAndToggleSubmitButton();
        });

        // ... (upload file, copy and paste, edit existing handlers unchanged) ...
//20250717Insert Begin
                // Upload file
        $(document).on('click', '#uploadFileBtn', function() {
            isEditingExisting = false;
            selectedHeaderId = null;
            newRowData = { checked: true }; // Reset new row data
            $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Upload an Excel file with the required columns.');
            $('#divUserInput').html(`
                <div class="mb-3">
                    <p>Instructions: Open Munis, navigate to Enterprise ERP > Human Capital Management > Payroll > Employee Maintenance > Employee Inquiry. Select employees with Status > Active, choose a department range or other fields, then click Excel to export. Ensure the file includes: Department Code Desc, Job Class Code Desc, Scheduled Hours, Hourly Rate, Annual Pay.</p>
                    <label for="excelFile" class="form-label">Upload Excel File (.xlsx, max 50MB)</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx">
                </div>
                <button type="button" id="processExcelBtn" class="btn btn-primary">Process File</button>
                <button type="button" class="btn btn-secondary ms-2" onclick="showInputOptions()">Back to Input Options</button>
            `);
        });

        $(document).on('click', '#processExcelBtn', function() {
            const fileInput = $('#excelFile')[0];
            if (!fileInput.files.length) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please select a file.');
                return;
            }

            const formData = new FormData();
            formData.append('excelFile', fileInput.files[0]);

            $.ajax({
                url: 'ajax/processExcel.php',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
console.table(response.data);                        
                        tableData = response.data.map(row => ({ ...row, checked: true }));
                        newRowData = { checked: true }; // Reset new row data
                        renderTable(response.email, response.town);
                        validateAndToggleSubmitButton();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error processing Excel file.');
                }
            });
        });

        // Copy and paste
        $(document).on('click', '#copyPasteBtn', function() {
            isEditingExisting = false;
            selectedHeaderId = null;
            newRowData = { checked: true }; // Reset new row data
            $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Paste tab-separated data (copy directly from Excel) or comma-separated data. Columns: Job Class Code Desc, Department Code Desc, Scheduled Hours, Hourly Rate, Annual Pay.');
            $('#divUserInput').html(`
                <div class="mb-3">
                    <label for="uiCopyPasteData" class="form-label">Paste Data (tab-separated from Excel or comma-separated)</label>
                    <textarea class="form-control" id="uiCopyPasteData" rows="10" placeholder="Copy from Excel or enter comma-separated data"></textarea>
                </div>
                <button type="button" id="btnProcessCopyAndPasteData" class="btn btn-primary">Process Data</button>
                <button type="button" class="btn btn-secondary ms-2" onclick="showInputOptions()">Back to Input Options</button>
            `);
        });

        $(document).on('click', '#btnProcessCopyAndPasteData', function() {
            const data = $('#uiCopyPasteData').val().trim();
            if (!data) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please paste some data.');
                return;
            }

            const rows = data.split('\n').filter(row => row.trim() !== '');
            if (rows.length < 2) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please include a header row and at least one data row.');
                return;
            }

            const delimiter = (rows[0].includes('\t') && substr_count(rows[0], '\t') >= 4) ? '\t' : ',';
            const firstRowColumns = parseCSVRow(rows[0], delimiter).length;

            for (let i = 1; i < rows.length; i++) {
                const rowColumns = parseCSVRow(rows[i], delimiter).length;
                if (rowColumns !== firstRowColumns) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Inconsistent number of columns in row ' + (i + 1) + '. Expected ' + firstRowColumns + ' but found ' + rowColumns + '.');
                    return;
                }
            }

            $.ajax({
                url: 'ajax/processCopyPaste.php',
                type: 'POST',
                data: { data },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        tableData = response.data.map(row => ({ ...row, checked: true }));
                        newRowData = { checked: true }; // Reset new row data
                        renderTable(response.email, response.town);
                        validateAndToggleSubmitButton();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error processing pasted data.');
                }
            });
        });

        // Edit existing data
        $(document).on('click', '#editExistingBtn', function() {
            isEditingExisting = true;
            $.ajax({
                url: 'ajax/checkExistingData.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.hasData) {
                        const headers = response.headers;
                        const email = response.email;
                        const town = response.town;
                        let options = headers.map(header => 
                            `<option value="${header.id}">${header.uploadDate || 'No Date'}</option>`
                        ).join('');
                        $('#divMessage').removeClass('alert-danger').addClass('alert-info').text('Select a dataset to edit.');
                        $('#divUserInput').html(`
                            <div class="mb-3">
                                <label for="headerSelect" class="form-label">Select Dataset (Uploaded On)</label>
                                <select class="form-control" id="headerSelect">
                                    <option value="">-- Select a dataset --</option>
                                    ${options}
                                </select>
                            </div>
                            <button type="button" id="loadHeaderDataBtn" class="btn btn-primary">Load Data</button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="showInputOptions()">Back to Input Options</button>
                        `);
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error retrieving existing data.');
                }
            });
        });

        $(document).on('click', '#loadHeaderDataBtn', function() {
            const headerId = $('#headerSelect').val();
            if (!headerId) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Please select a dataset to edit.');
                return;
            }

            selectedHeaderId = headerId;
            $.ajax({
                url: 'ajax/loadDetailData.php',
                type: 'POST',
                data: { headerId },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        //tableData = response.data;
                        tableData = response.data.map(row => ({ ...row, checked: true }));
                        newRowData = { checked: true }; // Reset new row data
                        console.log('Got back from loadDetailData. for header:'+headerId);
                        console.log('Got back from loadDetailData. here is the table:');
                        console.table(tableData);
                        console.log('Got back from loadDetailData. for header:'+headerId);
                        renderTable();
                        validateAndToggleSubmitButton();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Error loading dataset.');
                }
            });
        });

        // Handle select all
        $(document).on('change', '#selectAll', function() {
            const checked = $(this).prop('checked');
            $('.row-checkbox').prop('checked', checked).each(function() {
                const index = $(this).data('index');
                if (tableData[index]) {
                    tableData[index].checked = checked;
                    $(this).closest('tr').toggleClass('checked-row', checked).toggleClass('unchecked-row', !checked);
                    // Update blank cell highlighting
                    $(this).closest('tr').find('.editable-cell').each(function() {
                        const column = $(this).data('column');
                        const value = tableData[index][column] || '';
                        $(this).toggleClass('blank-cell', checked && (!value || value.trim() === ''));
                    });
                }
            });
            validateAndToggleSubmitButton();
        });

        // Handle row checkbox
        $(document).on('change', '.row-checkbox', function() {
            const index = $(this).data('index');
            if (tableData[index]) {
                tableData[index].checked = $(this).prop('checked');
                $(this).closest('tr').toggleClass('checked-row', tableData[index].checked).toggleClass('unchecked-row', !tableData[index].checked);
                // Update blank cell highlighting
                $(this).closest('tr').find('.editable-cell').each(function() {
                    const column = $(this).data('column');
                    const value = tableData[index][column] || '';
                    $(this).toggleClass('blank-cell', tableData[index].checked && (!value || value.trim() === ''));
                });
                updateSelectAll();
                validateAndToggleSubmitButton();
            }
        });

        // Update select all checkbox
        function updateSelectAll() {
            const allChecked = $('.row-checkbox').length === $('.row-checkbox:checked').length;
            $('#selectAll').prop('checked', allChecked);
        }

        // Handle cell edits
        $(document).on('blur', '.editable-cell:not(.new-row)', function() {
            const index = $(this).data('index');
            const column = $(this).data('column');
            const value = $(this).text().trim();
            if (index !== undefined && tableData[index]) {
                if ((column >= 3 && !isNaN(value) && value !== '') || (column < 3)) {
                    tableData[index][column] = value;
                    $(this).removeClass('blank-cell');
                    if (tableData[index].checked && (!value || value.trim() === '')) {
                        $(this).addClass('blank-cell');
                    }
                } else if (column >= 3) {
                    $(this).text(tableData[index][column] || '');
                    alert('Please enter a numeric value for ' + columns.find(c => c.id == column).name);
                }
            }
            validateAndToggleSubmitButton();
        });

//20250717Insert End
        // Handle standard department and job class selection
        $(document).on('change', '.standard-dept', function() {
            const index = $(this).data('index');
            const value = $(this).val();
            if (index !== undefined && tableData[index]) {
                tableData[index].standardDeptID = value ? parseInt(value) : null;
            } else {
                newRowData.standardDeptID = value ? parseInt(value) : null;
            }
            validateAndToggleSubmitButton();
        });

        $(document).on('change', '.standard-job', function() {
            const index = $(this).data('index');
            const value = $(this).val();
            if (index !== undefined && tableData[index]) {
                tableData[index].standardJobClassID = value ? parseInt(value) : null;
            } else {
                newRowData.standardJobClassID = value ? parseInt(value) : null;
            }
            validateAndToggleSubmitButton();
        });

        // Handle new row cell edits
        $(document).on('input', '.new-row.editable-cell', function() {
            const column = $(this).data('column');
            const value = $(this).text().trim();
            console.log('Input in column:', column, 'value:', value); // Debug

            // Update newRowData and validate input
            if ((column >= 3 && !isNaN(value) && value !== '') || (column < 3)) {
                newRowData[column] = value;
                $(this).removeClass('blank-cell');
                if (!value || value.trim() === '') {
                    newRowData[column] = '';
                    $(this).addClass('blank-cell');
                }
            } else if (column >= 3 && value !== '') {
                $(this).text('');
                newRowData[column] = '';
                alert('Please enter a numeric value for ' + columns.find(c => c.id == column).name);
                $(this).addClass('blank-cell');
                return; // Exit to prevent checking row completion with invalid data
            }
            console.log('newRowData:', newRowData); // Debug

            // Check if all columns are filled and valid
            let allFilled = true;
            let isValid = true;
            for (let i = 1; i <= 5; i++) {
                const val = newRowData[i] || '';
                if (!val || val.trim() === '') {
                    allFilled = false;
                }
                if (i >= 3 && val && isNaN(val)) {
                    isValid = false;
                }
            }
            console.log('allFilled:', allFilled, 'isValid:', isValid); // Debug

            if (allFilled && isValid) {
                console.log('Committing newRowData to tableData:', { ...newRowData }); // Debug
                const newRowIndex = tableData.length; // Index of the newly added row
                tableData.push({ ...newRowData });
                newRowData = { checked: true }; // Reset new row data
                renderTable();
                // Restore focus to the same column in the newly added row
                const newCell = $(`.editable-cell[data-index="${newRowIndex}"][data-column="${column}"]`);
                if (newCell.length) {
                    newCell.focus();
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(newCell[0]);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
                $('.new-row.editable-cell').each(function() {
                    const col = $(this).data('column');
                    $(this).toggleClass('blank-cell', !newRowData[col] || newRowData[col].trim() === '');
                });
            }
            validateAndToggleSubmitButton();
        });

        // Handle new row submission (on Enter key)
        $(document).on('keydown', '.new-row.editable-cell', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const column = $(this).data('column');
                let hasData = false;
                let isValid = true;
                $('.new-row.editable-cell').each(function() {
                    const col = $(this).data('column');
                    const value = $(this).text().trim();
                    if (value) {
                        hasData = true;
                        if (col >= 3 && isNaN(value)) {
                            isValid = false;
                            alert('Please enter a numeric value for ' + columns.find(c => c.id == col).name);
                            $(this).text('');
                            newRowData[col] = '';
                            $(this).addClass('blank-cell');
                        } else {
                            newRowData[col] = value;
                        }
                    } else {
                        newRowData[col] = '';
                        $(this).addClass('blank-cell');
                    }
                });

                if (hasData && isValid) {
                    console.log('Enter key: Committing newRowData to tableData:', { ...newRowData }); // Debug
                    const newRowIndex = tableData.length; // Index of the newly added row
                    tableData.push({ ...newRowData });
                    newRowData = { checked: true }; // Reset new row data
                    renderTable();
                    const newCell = $(`.editable-cell[data-index="${newRowIndex}"][data-column="${column}"]`);
                    if (newCell.length) {
                        newCell.focus();
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(newCell[0]);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                    $('.new-row.editable-cell').each(function() {
                        const col = $(this).data('column');
                        $(this).toggleClass('blank-cell', !newRowData[col] || newRowData[col].trim() === '');
                    });
                }
                validateAndToggleSubmitButton();
            }
        });

        // Submit data
        $(document).on('click', '#submitDataBtn', function() {
            if (!tableData.length) {
                $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('No data to submit.');
                return;
            }
            // Validate tableData structure
            for (let row of tableData) {
                if (!row.hasOwnProperty('checked')) {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('Invalid data: Missing checked property.');
                    return;
                }
                for (let i = 1; i <= 5; i++) {
                    if (row.checked && (!row[i] || row[i].trim() === '')) {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(`Missing value in column ${columns.find(c => c.id == i).name} for a checked row.`);
                        return;
                    }
                    if (row[i] && i >= 3 && isNaN(row[i])) {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(`Invalid numeric value in column ${i}.`);
                        return;
                    }
                }
            }
            const url = isEditingExisting ? 'ajax/updateData.php' : 'ajax/submitData.php';
            const dataToSend = isEditingExisting ? { headerId: selectedHeaderId, data: tableData } : tableData;
            console.log('Submitting to:', url);
            console.log('Data to send:', JSON.stringify(dataToSend, null, 2));
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                dataType: 'json',
                success: function(response) {
                    console.log('Response:', response);
                    if (response.success) {
                        $('#divMessage').removeClass('alert-danger').addClass('alert-success').text(response.message);
                        tableData = [];
                        newRowData = { checked: true }; // Reset new row data
                        renderTable();
                        showInputOptions();
                    } else {
                        $('#divMessage').removeClass('alert-info').addClass('alert-danger').text(response.message);
                    }
                },
                error: function() {
                    $('#divMessage').removeClass('alert-info').addClass('alert-danger').text('An error occurred. Please try again.');
                }
            });
        });
    });
</script>
</body>
</html>